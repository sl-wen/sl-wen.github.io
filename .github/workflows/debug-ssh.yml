# SSH连接调试工作流
name: Debug SSH Connection

# 手动触发
on:
  workflow_dispatch:

jobs:
  debug-ssh:
    runs-on: ubuntu-latest
    
    steps:
      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_KEY }}
          port: 22
          timeout: 30s
          debug: true
          script: |
            echo "🔍 SSH连接调试信息"
            echo "=================="
            
            # 系统信息
            echo "📋 系统信息:"
            uname -a
            whoami
            pwd
            
            # 检查目录
            echo ""
            echo "📁 目录检查:"
            ls -la /var/www/
            
            if [ -d "/var/www/blog" ]; then
                echo "✅ /var/www/blog 目录存在"
                cd /var/www/blog
                ls -la
                
                # Git状态
                if [ -d ".git" ]; then
                    echo ""
                    echo "📋 Git状态:"
                    git status
                    git remote -v
                    git branch -a
                else
                    echo "❌ 不是Git仓库"
                fi
            else
                echo "❌ /var/www/blog 目录不存在"
            fi
            
            # Node.js环境
            echo ""
            echo "📋 Node.js环境:"
            which node && node --version || echo "❌ Node.js未安装"
            which npm && npm --version || echo "❌ npm未安装"
            
            # 服务状态
            echo ""
            echo "📋 服务状态:"
            sudo systemctl is-active blog || echo "blog服务未运行"
            sudo systemctl status blog --no-pager -l || echo "blog服务不存在"
            
            # 端口检查
            echo ""
            echo "📋 端口检查:"
            sudo netstat -tlnp | grep :3000 || echo "端口3000未被占用"
            
            # 权限检查
            echo ""
            echo "📋 权限检查:"
            ls -la /var/www/blog/ | head -10
            
            echo ""
            echo "🎉 调试信息收集完成！"

      - name: Test Simple Commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_KEY }}
          port: 22
          timeout: 30s
          script: |
            echo "🧪 测试基本命令"
            echo "=============="
            
            # 测试sudo权限
            echo "测试sudo权限:"
            sudo whoami || echo "❌ sudo权限测试失败"
            
            # 测试网络连接
            echo "测试网络连接:"
            curl -I http://localhost:3000 || echo "❌ 本地3000端口无响应"
            
            # 测试Git连接
            echo "测试Git连接:"
            git ls-remote https://github.com/sl-wen/sl-wen.github.io.git || echo "❌ Git连接失败"
            
            echo "🎉 基本命令测试完成！" 