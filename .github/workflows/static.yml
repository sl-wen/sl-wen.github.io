# Ubuntu 24.04 æœåŠ¡å™¨æ›´æ–°éƒ¨ç½²å·¥ä½œæµ
name: Update Deployed Server

on:
  # åœ¨reactåˆ†æ”¯æœ‰æ¨é€æ—¶è§¦å‘
  push:
    branches: ["react"]
  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      # é€šè¿‡SSHè¿æ¥UbuntuæœåŠ¡å™¨ï¼Œæ›´æ–°ä»£ç å¹¶é‡æ–°æ„å»º
      - name: Update and Rebuild on Ubuntu Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 20m
          script: |
            set -e
            
            echo "=== å¼€å§‹æœåŠ¡å™¨æ›´æ–° ==="
            echo "ğŸ“‹ æ›´æ–°æ—¶é—´: $(date)"
            echo "ğŸ“‹ æœåŠ¡å™¨: $(hostname) - $(lsb_release -d | cut -f2)"
            
            # æ£€æŸ¥åº”ç”¨ç›®å½•
            if [ ! -d "/var/www/blog" ]; then
              echo "âŒ åº”ç”¨ç›®å½•ä¸å­˜åœ¨: /var/www/blog"
              exit 1
            fi
            
            cd /var/www/blog
            
            # æ˜¾ç¤ºå½“å‰çŠ¶æ€
            echo "ğŸ“‹ æ›´æ–°å‰çŠ¶æ€:"
            echo "  å½“å‰åˆ†æ”¯: $(git branch --show-current)"
            echo "  å½“å‰æäº¤: $(git log --oneline -n 1)"
            echo "  å†…å­˜çŠ¶æ€: $(free -h | grep Mem | awk '{print $3 "/" $2 " (å¯ç”¨:" $7 ")"}')"
            
            # å¤‡ä»½å½“å‰æ„å»º
            echo "ğŸ’¾ å¤‡ä»½å½“å‰æ„å»º..."
            if [ -d ".next" ]; then
                rm -rf .next.backup
                cp -r .next .next.backup
                echo "âœ… æ„å»ºæ–‡ä»¶å·²å¤‡ä»½"
            fi
            
            # åœæ­¢æœåŠ¡
            echo "ğŸ›‘ åœæ­¢blogæœåŠ¡..."
            if systemctl is-active --quiet blog; then
                sudo systemctl stop blog
                echo "âœ… blogæœåŠ¡å·²åœæ­¢"
            else
                echo "ğŸ“‹ blogæœåŠ¡æœªè¿è¡Œ"
            fi
            
            # æ¸…ç†æ®‹ç•™è¿›ç¨‹
            echo "ğŸ§¹ æ¸…ç†è¿›ç¨‹..."
            pkill -TERM -f "next start" 2>/dev/null || true
            pkill -TERM -f "npm start" 2>/dev/null || true
            sleep 3
            pkill -KILL -f "next start" 2>/dev/null || true
            pkill -KILL -f "npm start" 2>/dev/null || true
            
            # æš‚å­˜æœ¬åœ°æ›´æ”¹
            if ! git diff --quiet || ! git diff --cached --quiet; then
                echo "ğŸ“¦ æš‚å­˜æœ¬åœ°æ›´æ”¹..."
                git stash push -u -m "Auto stash before update $(date)"
            fi
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            BEFORE_COMMIT=$(git rev-parse HEAD)
            git reset --hard origin/react
            git clean -fd
            AFTER_COMMIT=$(git rev-parse HEAD)
            
            # æ˜¾ç¤ºæ›´æ–°ä¿¡æ¯
            if [ "$BEFORE_COMMIT" != "$AFTER_COMMIT" ]; then
                echo "âœ… ä»£ç å·²æ›´æ–°:"
                git log --oneline $BEFORE_COMMIT..$AFTER_COMMIT | head -5
            else
                echo "ğŸ“‹ ä»£ç æ— å˜åŒ–"
            fi
            echo "ğŸ“‹ å½“å‰ç‰ˆæœ¬: $(git log --oneline -n 1)"
            
            # æ›´æ–°ç¯å¢ƒå˜é‡
            echo "ğŸ”§ æ›´æ–°ç¯å¢ƒå˜é‡..."
            cat > .env.local << 'EOF'
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_KEY }}
            NODE_ENV=production
            EOF
            
            # æ£€æŸ¥å†…å­˜çŠ¶æ€
            MEM_AVAILABLE=$(free -m | grep Mem | awk '{print $7}')
            echo "ğŸ“Š å¯ç”¨å†…å­˜: ${MEM_AVAILABLE}MB"
            
            # å¦‚æœå†…å­˜ä¸è¶³ï¼Œæ¸…ç†ç¼“å­˜
            if [ $MEM_AVAILABLE -lt 300 ]; then
                echo "âš ï¸  å†…å­˜ä¸è¶³ï¼Œæ¸…ç†ç¼“å­˜..."
                sudo sync
                sudo sh -c 'echo 1 > /proc/sys/vm/drop_caches'
                npm cache clean --force || true
                MEM_AVAILABLE=$(free -m | grep Mem | awk '{print $7}')
                echo "ğŸ“Š æ¸…ç†åå¯ç”¨å†…å­˜: ${MEM_AVAILABLE}MB"
            fi
            
            # è®¾ç½®Node.jså†…å­˜é™åˆ¶
            if [ $MEM_AVAILABLE -lt 400 ]; then
                export NODE_OPTIONS="--max-old-space-size=256"
                echo "ğŸ”§ è®¾ç½®ä½å†…å­˜æ¨¡å¼: 256MB"
            else
                export NODE_OPTIONS="--max-old-space-size=512"
                echo "ğŸ”§ è®¾ç½®æ ‡å‡†å†…å­˜æ¨¡å¼: 512MB"
            fi
            
            # æ›´æ–°ä¾èµ–ï¼ˆå¦‚æœpackage.jsonæœ‰å˜åŒ–ï¼‰
            if git diff --name-only $BEFORE_COMMIT $AFTER_COMMIT | grep -q "package.json"; then
                echo "ğŸ“¦ package.jsonæœ‰å˜åŒ–ï¼Œæ›´æ–°ä¾èµ–..."
                npm ci --production --no-audit --no-fund
                echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ"
            else
                echo "ğŸ“‹ ä¾èµ–æ— éœ€æ›´æ–°"
            fi
            
            # é‡æ–°æ„å»º
            echo "ğŸ”¨ é‡æ–°æ„å»ºåº”ç”¨..."
            rm -rf .next
            
            # ä½¿ç”¨timeouté˜²æ­¢æ„å»ºå¡æ­»
            if timeout 900 npm run build; then
                echo "âœ… æ„å»ºæˆåŠŸ"
                BUILD_SIZE=$(du -sh .next | awk '{print $1}')
                echo "ğŸ“Š æ„å»ºå¤§å°: $BUILD_SIZE"
            else
                echo "âŒ æ„å»ºå¤±è´¥ï¼Œæ¢å¤å¤‡ä»½..."
                if [ -d ".next.backup" ]; then
                    rm -rf .next
                    mv .next.backup .next
                    echo "ğŸ”„ å·²æ¢å¤å¤‡ä»½ç‰ˆæœ¬"
                else
                    echo "âŒ æ— å¤‡ä»½å¯æ¢å¤"
                    exit 1
                fi
            fi
            
            # å¯åŠ¨æœåŠ¡
            echo "ğŸš€ å¯åŠ¨blogæœåŠ¡..."
            sudo systemctl start blog
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            SERVICE_STARTED=false
            for i in {1..6}; do
                if systemctl is-active --quiet blog; then
                    echo "âœ… blogæœåŠ¡å¯åŠ¨æˆåŠŸ (å°è¯• $i/6)"
                    SERVICE_STARTED=true
                    break
                else
                    echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... (å°è¯• $i/6)"
                    if [ $i -eq 6 ]; then
                        echo "âŒ blogæœåŠ¡å¯åŠ¨å¤±è´¥"
                        echo "ğŸ“‹ æœåŠ¡çŠ¶æ€:"
                        systemctl status blog --no-pager
                        echo "ğŸ“‹ æœåŠ¡æ—¥å¿—:"
                        journalctl -u blog --no-pager -n 10
                        
                        # å°è¯•æ¢å¤å¤‡ä»½
                        if [ -d ".next.backup" ]; then
                            echo "ğŸ”„ å°è¯•æ¢å¤å¤‡ä»½..."
                            sudo systemctl stop blog
                            rm -rf .next
                            mv .next.backup .next
                            sudo systemctl start blog
                            sleep 10
                            if systemctl is-active --quiet blog; then
                                echo "âœ… å¤‡ä»½æ¢å¤æˆåŠŸ"
                                SERVICE_STARTED=true
                            fi
                        fi
                        
                        if [ "$SERVICE_STARTED" = "false" ]; then
                            exit 1
                        fi
                    fi
                    sleep 8
                fi
            done
            
            # ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
            echo "â³ ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨..."
            sleep 15
            
            # æ£€æŸ¥åº”ç”¨å“åº”
            APP_RESPONDING=false
            for i in {1..5}; do
                if curl -f --connect-timeout 10 http://localhost:3000 > /dev/null 2>&1; then
                    echo "âœ… åº”ç”¨å“åº”æ­£å¸¸ (å°è¯• $i/5)"
                    APP_RESPONDING=true
                    break
                else
                    echo "â³ ç­‰å¾…åº”ç”¨å“åº”... (å°è¯• $i/5)"
                    if [ $i -eq 5 ]; then
                        echo "âŒ åº”ç”¨æ— å“åº”"
                        echo "ğŸ“‹ æœ€è¿‘æ—¥å¿—:"
                        journalctl -u blog --no-pager -n 10
                        
                        # æœ€åå°è¯•æ¢å¤å¤‡ä»½
                        if [ -d ".next.backup" ]; then
                            echo "ğŸ”„ æœ€åå°è¯•æ¢å¤å¤‡ä»½..."
                            sudo systemctl stop blog
                            rm -rf .next
                            mv .next.backup .next
                            sudo systemctl start blog
                            sleep 15
                            if curl -f --connect-timeout 10 http://localhost:3000 > /dev/null 2>&1; then
                                echo "âœ… å¤‡ä»½æ¢å¤æˆåŠŸ"
                                APP_RESPONDING=true
                            fi
                        fi
                        
                        if [ "$APP_RESPONDING" = "false" ]; then
                            exit 1
                        fi
                    fi
                    sleep 10
                fi
            done
            
            # æ£€æŸ¥nginxçŠ¶æ€
            if systemctl is-active --quiet nginx; then
                echo "âœ… nginxæœåŠ¡æ­£å¸¸"
                if curl -f --connect-timeout 5 http://localhost > /dev/null 2>&1; then
                    echo "âœ… nginxä»£ç†æ­£å¸¸"
                else
                    echo "âš ï¸  nginxä»£ç†å¼‚å¸¸ï¼Œé‡å¯nginx..."
                    sudo systemctl restart nginx
                fi
            else
                echo "âš ï¸  nginxæœåŠ¡æœªè¿è¡Œï¼Œå¯åŠ¨nginx..."
                sudo systemctl start nginx
            fi
            
            # æ¸…ç†å¤‡ä»½æ–‡ä»¶
            rm -rf .next.backup
            
            # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
            echo ""
            echo "ğŸ‰ æ›´æ–°éƒ¨ç½²å®Œæˆï¼"
            echo ""
            echo "ğŸ“Š æœ€ç»ˆçŠ¶æ€:"
            echo "  blogæœåŠ¡: $(systemctl is-active blog)"
            echo "  nginxæœåŠ¡: $(systemctl is-active nginx)"
            echo "  åº”ç”¨ç«¯å£: $(netstat -tlnp | grep :3000 | wc -l) ä¸ªç›‘å¬"
            echo "  å†…å­˜ä½¿ç”¨: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
            echo "ğŸ”— è®¿é—®åœ°å€: http://${{ secrets.SERVER_IP }}"
            echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: $(git log --oneline -n 1)"
            echo ""
            echo "=== æ›´æ–°å®Œæˆ ==="
            echo "ğŸ“‹ å®Œæˆæ—¶é—´: $(date)"

      # éƒ¨ç½²åé€šçŸ¥
      - name: Update Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… æœåŠ¡å™¨æ›´æ–°æˆåŠŸï¼"
            echo "ğŸ”— è®¿é—®åœ°å€: http://${{ secrets.SERVER_IP }}"
            echo "ğŸ“‹ æ›´æ–°æ—¶é—´: $(date)"
            echo "ğŸ‰ ç½‘ç«™å·²æ›´æ–°å¹¶æ­£åœ¨è¿è¡Œ"
          else
            echo "âŒ æœåŠ¡å™¨æ›´æ–°å¤±è´¥"
            echo "ğŸ’¡ æ•…éšœæ’é™¤æç¤º:"
            echo "  1. æ£€æŸ¥æœåŠ¡å™¨å†…å­˜æ˜¯å¦å……è¶³"
            echo "  2. æŸ¥çœ‹GitHub Actionsæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
            echo "  3. æ£€æŸ¥æœåŠ¡å™¨SSHè¿æ¥"
            echo "  4. ç³»ç»Ÿå·²è‡ªåŠ¨å°è¯•å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬"
            echo "  5. å¦‚éœ€æ‰‹åŠ¨æ£€æŸ¥ï¼Œè¿è¡Œ: systemctl status blog"
          fi
