# Ubuntu 24.04 æœåŠ¡å™¨éƒ¨ç½²å·¥ä½œæµ
name: Deploy to Ubuntu Server

on:
  # åœ¨reactåˆ†æ”¯æœ‰æ¨é€æ—¶è§¦å‘
  push:
    branches: ["react"]
  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # é€šè¿‡SSHè¿æ¥UbuntuæœåŠ¡å™¨ï¼Œæ‹‰å–ä»£ç å¹¶æ„å»º
      - name: Deploy via Git Pull on Ubuntu Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_KEY }}
          port: 22
          timeout: 180s
          command_timeout: 25m
          script: |
            set -e
            
            # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "/var/www/blog" ]; then
              echo "âŒ åº”ç”¨ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œåˆå§‹åŒ–è„šæœ¬"
              echo "ğŸ’¡ è¿è¡Œ: curl -sSL https://raw.githubusercontent.com/sl-wen/sl-wen.github.io/react/init-server.sh | bash"
              exit 1
            fi
            
            cd /var/www/blog
            
            echo "=== å¼€å§‹UbuntuæœåŠ¡å™¨éƒ¨ç½² ==="
            echo "ğŸ“‹ ç³»ç»Ÿä¿¡æ¯: $(lsb_release -d | cut -f2)"
            echo "â° éƒ¨ç½²æ—¶é—´: $(date)"
            
            # æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ
            echo "ğŸ“‹ æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ..."
            node --version || { echo "âŒ Node.jsæœªå®‰è£…"; exit 1; }
            npm --version || { echo "âŒ npmæœªå®‰è£…"; exit 1; }
            git --version || { echo "âŒ Gitæœªå®‰è£…"; exit 1; }
            
            # æ£€æŸ¥ç³»ç»Ÿèµ„æº
            echo "ğŸ“Š ç³»ç»Ÿèµ„æºçŠ¶æ€:"
            echo "  å†…å­˜: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
            echo "  ç£ç›˜: $(df -h /var/www/blog | tail -1 | awk '{print $3 "/" $2 " (" $5 ")"}')"
            
            # æ£€æŸ¥GitçŠ¶æ€å¹¶æ¸…ç†
            echo "ğŸ“‹ æ£€æŸ¥Gitä»“åº“çŠ¶æ€..."
            if ! git rev-parse --git-dir > /dev/null 2>&1; then
                echo "âŒ ä¸æ˜¯Gitä»“åº“"
                exit 1
            fi
            
            # æ˜¾ç¤ºå½“å‰çŠ¶æ€
            echo "ğŸ“‹ å½“å‰åˆ†æ”¯: $(git branch --show-current)"
            echo "ğŸ“‹ å½“å‰æäº¤: $(git log --oneline -n 1)"
            
            # æ¸…ç†Gitå·¥ä½œåŒº
            echo "ğŸ§¹ æ¸…ç†Gitå·¥ä½œåŒº..."
            if ! git diff --quiet || ! git diff --cached --quiet; then
                echo "âš ï¸  å‘ç°æœªæäº¤çš„æ›´æ”¹ï¼Œæ­£åœ¨æš‚å­˜..."
                git stash push -u -m "Auto stash before deployment $(date)"
            fi
            git reset --hard HEAD
            git clean -fd
            
            # åœæ­¢ç°æœ‰æœåŠ¡
            echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
            if systemctl list-unit-files | grep -q "blog.service"; then
                if systemctl is-active --quiet blog; then
                    sudo systemctl stop blog
                    echo "âœ… blogæœåŠ¡å·²åœæ­¢"
                else
                    echo "ğŸ“‹ blogæœåŠ¡æœªè¿è¡Œ"
                fi
            else
                echo "ğŸ“‹ blogæœåŠ¡ä¸å­˜åœ¨ï¼Œå°†ç¨ååˆ›å»º"
            fi
            
            # ç»ˆæ­¢å¯èƒ½çš„æ®‹ç•™è¿›ç¨‹
            pkill -f "next start" || echo "ğŸ“‹ æ²¡æœ‰è¿è¡Œä¸­çš„Next.jsè¿›ç¨‹"
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            echo "ğŸ’¾ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            if [ -d ".next" ]; then
                rm -rf .next.backup
                cp -r .next .next.backup
                echo "âœ… æ„å»ºæ–‡ä»¶å·²å¤‡ä»½"
            fi
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin || { echo "âŒ Git fetchå¤±è´¥"; exit 1; }
            BEFORE_COMMIT=$(git rev-parse HEAD)
            git reset --hard origin/react || { echo "âŒ Git resetå¤±è´¥"; exit 1; }
            git clean -fd
            AFTER_COMMIT=$(git rev-parse HEAD)
            
            # æ˜¾ç¤ºæ›´æ–°ä¿¡æ¯
            if [ "$BEFORE_COMMIT" != "$AFTER_COMMIT" ]; then
                echo "ğŸ“‹ ä»£ç å·²æ›´æ–°:"
                git log --oneline $BEFORE_COMMIT..$AFTER_COMMIT
            else
                echo "ğŸ“‹ ä»£ç æ— å˜åŒ–"
            fi
            
            echo "ğŸ“‹ å½“å‰ç‰ˆæœ¬: $(git log --oneline -n 1)"
            
            # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
            echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
            cat > .env.local << 'EOF'
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_KEY }}
            NODE_ENV=production
            EOF
            echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"
            
            # æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶å’Œç¼“å­˜
            echo "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
            rm -rf node_modules/.cache
            rm -rf .next
            npm cache clean --force
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm ci || { echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            
            # æ„å»ºåº”ç”¨
            echo "ğŸ”¨ æ„å»ºåº”ç”¨..."
            npm run build || { 
                echo "âŒ æ„å»ºå¤±è´¥"
                echo "ğŸ“‹ æ„å»ºæ—¥å¿—:"
                npm run build 2>&1 | tail -20
                exit 1
            }
            echo "âœ… åº”ç”¨æ„å»ºå®Œæˆ"
            
            # è®¾ç½®æƒé™
            echo "ğŸ” è®¾ç½®æƒé™..."
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} /var/www/blog
            sudo chmod -R 755 /var/www/blog
            
            # åˆ›å»ºsystemdæœåŠ¡ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if ! systemctl list-unit-files | grep -q "blog.service"; then
                echo "ğŸ”§ åˆ›å»ºsystemdæœåŠ¡..."
                sudo tee /etc/systemd/system/blog.service > /dev/null <<EOF
            [Unit]
            Description=Blog Next.js App
            After=network.target
            
            [Service]
            Type=simple
            User=${{ secrets.SERVER_USER }}
            WorkingDirectory=/var/www/blog
            ExecStart=/usr/bin/npm start
            Restart=on-failure
            RestartSec=10
            Environment=NODE_ENV=production
            StandardOutput=journal
            StandardError=journal
            
            [Install]
            WantedBy=multi-user.target
            EOF
                sudo systemctl daemon-reload
                echo "âœ… systemdæœåŠ¡åˆ›å»ºå®Œæˆ"
            fi
            
            # å¯åŠ¨æœåŠ¡
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            sudo systemctl enable blog
            sudo systemctl start blog
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 20
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            if systemctl is-active --quiet blog; then
                echo "âœ… blogæœåŠ¡å¯åŠ¨æˆåŠŸ"
                
                # ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
                echo "â³ ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨..."
                sleep 15
                
                # æ£€æŸ¥åº”ç”¨ç«¯å£
                if netstat -tlnp | grep -q ":3000"; then
                    echo "âœ… åº”ç”¨ç«¯å£3000å·²ç›‘å¬"
                else
                    echo "âš ï¸  ç«¯å£3000æœªç›‘å¬"
                fi
                
                # æ£€æŸ¥åº”ç”¨æ˜¯å¦å“åº”
                echo "ğŸ§ª æµ‹è¯•åº”ç”¨å“åº”..."
                if curl -f http://localhost:3000 > /dev/null 2>&1; then
                    echo "âœ… åº”ç”¨å“åº”æ­£å¸¸"
                    
                    # æ£€æŸ¥NginxçŠ¶æ€
                    if systemctl is-active --quiet nginx; then
                        echo "âœ… NginxæœåŠ¡æ­£å¸¸"
                        
                        # æµ‹è¯•Nginxä»£ç†
                        if curl -f http://localhost > /dev/null 2>&1; then
                            echo "âœ… Nginxä»£ç†æ­£å¸¸"
                        else
                            echo "âš ï¸  Nginxä»£ç†å¯èƒ½æœ‰é—®é¢˜"
                        fi
                    else
                        echo "âš ï¸  NginxæœåŠ¡æœªè¿è¡Œ"
                        sudo systemctl start nginx || echo "âŒ Nginxå¯åŠ¨å¤±è´¥"
                    fi
                    
                    # æ¸…ç†å¤‡ä»½æ–‡ä»¶
                    rm -rf .next.backup
                    
                    echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
                else
                    echo "âŒ åº”ç”¨æ— å“åº”ï¼Œå°è¯•å›æ»š..."
                    sudo systemctl stop blog
                    
                    # å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬
                    if [ -d ".next.backup" ]; then
                        rm -rf .next
                        mv .next.backup .next
                        sudo systemctl start blog
                        echo "ğŸ”„ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
                        sleep 15
                        if curl -f http://localhost:3000 > /dev/null 2>&1; then
                            echo "âœ… å›æ»šæˆåŠŸ"
                        else
                            echo "âŒ å›æ»šä¹Ÿå¤±è´¥äº†"
                        fi
                    fi
                    
                    echo "ğŸ“‹ æœåŠ¡çŠ¶æ€:"
                    systemctl status blog --no-pager
                    echo "ğŸ“‹ æœ€è¿‘æ—¥å¿—:"
                    journalctl -u blog --no-pager -n 10
                    exit 1
                fi
            else
                echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œå°è¯•å›æ»š..."
                
                # å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬
                if [ -d ".next.backup" ]; then
                    rm -rf .next
                    mv .next.backup .next
                    sudo systemctl start blog
                    echo "ğŸ”„ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
                fi
                
                echo "ğŸ“‹ æœåŠ¡çŠ¶æ€:"
                systemctl status blog --no-pager
                echo "ğŸ“‹ æœåŠ¡æ—¥å¿—:"
                journalctl -u blog --no-pager -n 20
                exit 1
            fi
            
            echo "=== éƒ¨ç½²å®Œæˆ ==="
            echo "ğŸ“Š æœ€ç»ˆçŠ¶æ€:"
            echo "  blogæœåŠ¡: $(systemctl is-active blog)"
            echo "  nginxæœåŠ¡: $(systemctl is-active nginx)"
            echo "  åº”ç”¨ç«¯å£: $(netstat -tlnp | grep :3000 | wc -l) ä¸ªç›‘å¬"
            echo "ğŸ”— è®¿é—®åœ°å€: http://${{ secrets.SERVER_IP }}"
            echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: $(git log --oneline -n 1)"

      # éƒ¨ç½²åé€šçŸ¥
      - name: Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… UbuntuæœåŠ¡å™¨éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ”— è®¿é—®åœ°å€: http://${{ secrets.SERVER_IP }}"
            echo "ğŸ“‹ éƒ¨ç½²æ—¶é—´: $(date)"
            echo "ğŸ‰ ç½‘ç«™å·²æ›´æ–°å¹¶æ­£åœ¨è¿è¡Œ"
          else
            echo "âŒ UbuntuæœåŠ¡å™¨éƒ¨ç½²å¤±è´¥"
            echo "ğŸ’¡ æ•…éšœæ’é™¤æç¤º:"
            echo "  1. æ£€æŸ¥æœåŠ¡å™¨SSHè¿æ¥"
            echo "  2. ç¡®è®¤æœåŠ¡å™¨ç¯å¢ƒå·²æ­£ç¡®é…ç½®"
            echo "  3. æŸ¥çœ‹GitHub Actionsæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
            echo "  4. å¦‚æœæ˜¯é¦–æ¬¡éƒ¨ç½²ï¼Œè¯·å…ˆè¿è¡Œåˆå§‹åŒ–è„šæœ¬"
            echo "  5. ç³»ç»Ÿå·²è‡ªåŠ¨å°è¯•å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
          fi
