# æœåŠ¡å™¨ç«¯Gitæ‹‰å–å¹¶æ„å»ºéƒ¨ç½²å·¥ä½œæµ
name: Deploy to ALI

on:
  # åœ¨reactåˆ†æ”¯æœ‰æ¨é€æ—¶è§¦å‘
  push:
    branches: ["react"]
  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # é€šè¿‡SSHè¿æ¥æœåŠ¡å™¨ï¼Œæ‹‰å–ä»£ç å¹¶æ„å»º
      - name: Deploy via Git Pull on Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          script: |
            set -e
            
            # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "/var/www/blog" ]; then
              echo "âŒ åº”ç”¨ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºå¹¶å…‹éš†ä»£ç "
              exit 1
            fi
            
            cd /var/www/blog
            
            echo "=== å¼€å§‹æœåŠ¡å™¨ç«¯Gitéƒ¨ç½² ==="
            
            # æ£€æŸ¥Node.jsç‰ˆæœ¬
            echo "ğŸ“‹ æ£€æŸ¥ç¯å¢ƒ..."
            node --version || { echo "âŒ Node.jsæœªå®‰è£…"; exit 1; }
            npm --version || { echo "âŒ npmæœªå®‰è£…"; exit 1; }
            
            # æ£€æŸ¥GitçŠ¶æ€
            echo "ğŸ“‹ æ£€æŸ¥GitçŠ¶æ€..."
            git status || { echo "âŒ ä¸æ˜¯Gitä»“åº“"; exit 1; }
            
            # åœæ­¢ç°æœ‰æœåŠ¡
            echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
            sudo systemctl stop blog || echo "æœåŠ¡æœªè¿è¡Œ"
            sudo pkill -f "next start" || echo "æ²¡æœ‰è¿è¡Œä¸­çš„Next.jsè¿›ç¨‹"
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æœéœ€è¦å›æ»šï¼‰
            echo "ğŸ’¾ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            if [ -d ".next" ]; then
                rm -rf .next.backup
                mv .next .next.backup
            fi
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin || { echo "âŒ Git fetchå¤±è´¥"; exit 1; }
            git reset --hard origin/react || { echo "âŒ Git resetå¤±è´¥"; exit 1; }
            git clean -fd
            
            # æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬ä¿¡æ¯
            echo "ğŸ“‹ å½“å‰ç‰ˆæœ¬ä¿¡æ¯:"
            git log --oneline -n 3
            
            # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
            echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
            cat > .env.local << 'EOF'
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_KEY }}
            EOF
            
            # æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
            echo "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
            rm -rf node_modules
            npm cache clean --force
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm ci --production=false || { echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
            
            # æ„å»ºåº”ç”¨
            echo "ğŸ”¨ æ„å»ºåº”ç”¨..."
            npm run build || { echo "âŒ æ„å»ºå¤±è´¥"; exit 1; }
            
            # å®‰è£…ç”Ÿäº§ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
            npm ci --production --ignore-scripts || { echo "âŒ ç”Ÿäº§ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
            
            # è®¾ç½®æƒé™
            echo "ğŸ” è®¾ç½®æƒé™..."
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} /var/www/blog
            sudo chmod -R 755 /var/www/blog
            
            # å¯åŠ¨æœåŠ¡
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            sudo systemctl start blog
            sudo systemctl enable blog
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            if sudo systemctl is-active --quiet blog; then
                echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
                
                # æ£€æŸ¥åº”ç”¨æ˜¯å¦å“åº”
                if curl -f http://localhost:3000 > /dev/null 2>&1; then
                    echo "âœ… åº”ç”¨å“åº”æ­£å¸¸"
                    
                    # æ¸…ç†å¤‡ä»½æ–‡ä»¶
                    rm -rf .next.backup
                    
                    echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
                else
                    echo "âŒ åº”ç”¨æ— å“åº”ï¼Œå°è¯•å›æ»š..."
                    sudo systemctl stop blog
                    
                    # å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬
                    if [ -d ".next.backup" ]; then
                        rm -rf .next
                        mv .next.backup .next
                        sudo systemctl start blog
                        echo "ğŸ”„ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
                    fi
                    
                    sudo systemctl status blog
                    exit 1
                fi
            else
                echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œå°è¯•å›æ»š..."
                
                # å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬
                if [ -d ".next.backup" ]; then
                    rm -rf .next
                    mv .next.backup .next
                    sudo systemctl start blog
                    echo "ğŸ”„ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
                fi
                
                sudo systemctl status blog
                sudo journalctl -u blog --no-pager -n 20
                exit 1
            fi
            
            echo "=== éƒ¨ç½²å®Œæˆ ==="
            echo "ğŸ“Š æœåŠ¡çŠ¶æ€: $(sudo systemctl is-active blog)"
            echo "ğŸ”— è®¿é—®åœ°å€: http://${{ secrets.SERVER_IP }}"

      # éƒ¨ç½²åé€šçŸ¥
      - name: Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼ç½‘ç«™å·²æ›´æ–°åˆ°: http://${{ secrets.SERVER_IP }}"
            echo "ğŸ”— è®¿é—®åœ°å€: http://${{ secrets.SERVER_IP }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
            echo "ğŸ’¡ æç¤º: å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
          fi
