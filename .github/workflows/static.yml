# Ubuntu 24.04 æœåŠ¡å™¨æ›´æ–°éƒ¨ç½²å·¥ä½œæµ
name: Deploy to Server

on:
  # åœ¨reactåˆ†æ”¯æœ‰æ¨é€æ—¶è§¦å‘
  push:
    branches: [ react ]
  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: ${{ secrets.PORT }}
        timeout: 30s
        command_timeout: 10m
        script: |
          echo "=== å¼€å§‹éƒ¨ç½² ==="
          echo "æ—¶é—´: $(date)"
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /var/www/blog
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          echo "å½“å‰æäº¤: $(git log --oneline -n 1)"
          echo "å†…å­˜çŠ¶æ€: $(free -h | grep Mem)"
          
          # åœæ­¢æœåŠ¡
          echo "åœæ­¢blogæœåŠ¡..."
          sudo systemctl stop blog || true
          
          # æ¸…ç†è¿›ç¨‹
          echo "æ¸…ç†è¿›ç¨‹..."
          sudo pkill -f "npm" || true
          sudo pkill -f "node" || true
          sleep 2
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "æ‹‰å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git reset --hard origin/react
          
          # æ£€æŸ¥ä¾èµ–æ›´æ–°
          if git diff HEAD~1 --name-only | grep -q "package.json"; then
            echo "æ£€æµ‹åˆ°package.jsonå˜åŒ–ï¼Œæ›´æ–°ä¾èµ–..."
            npm install --production
          else
            echo "ä¾èµ–æ— å˜åŒ–ï¼Œè·³è¿‡å®‰è£…"
          fi
          
          # æ„å»ºåº”ç”¨
          echo "æ„å»ºåº”ç”¨..."
          export NODE_OPTIONS="--max-old-space-size=512"
          export NODE_ENV=production
          npm run build
          
          # å¯åŠ¨æœåŠ¡
          echo "å¯åŠ¨blogæœåŠ¡..."
          sudo systemctl start blog
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          if sudo systemctl is-active --quiet blog; then
            echo "âœ… blogæœåŠ¡å¯åŠ¨æˆåŠŸ"
          else
            echo "âŒ blogæœåŠ¡å¯åŠ¨å¤±è´¥"
            sudo systemctl status blog --no-pager -l
            exit 1
          fi
          
          # æ£€æŸ¥ç«¯å£
          if netstat -tlnp | grep -q ":3000"; then
            echo "âœ… ç«¯å£3000å·²ç›‘å¬"
          else
            echo "âŒ ç«¯å£3000æœªç›‘å¬"
            netstat -tlnp | grep LISTEN
            exit 1
          fi
          
          # æµ‹è¯•åº”ç”¨å“åº”
          echo "æµ‹è¯•åº”ç”¨å“åº”..."
          sleep 5
          if curl -f --connect-timeout 10 http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… åº”ç”¨å“åº”æ­£å¸¸"
          else
            echo "âŒ åº”ç”¨æ— å“åº”"
            sudo journalctl -u blog --no-pager -n 10
            exit 1
          fi
          
          # é‡å¯nginxï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if command -v nginx > /dev/null; then
            echo "é‡å¯nginx..."
            sudo systemctl restart nginx || true
          fi
          
          echo "=== éƒ¨ç½²å®Œæˆ ==="
          echo "æ—¶é—´: $(date)"
          echo "æœåŠ¡çŠ¶æ€: $(sudo systemctl is-active blog)"
          echo "å†…å­˜ä½¿ç”¨: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
          
          # æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
          EXTERNAL_IP=$(curl -s --connect-timeout 5 ifconfig.me 2>/dev/null || echo "unknown")
          if [ "$EXTERNAL_IP" != "unknown" ]; then
            echo "ğŸ”— è®¿é—®åœ°å€: http://$EXTERNAL_IP"
          fi
